---
import General from "../layouts/General.astro";

// constants
const URL = "http://localhost:3000/api";

// delete cookie when user is at Login page
Astro.cookies.delete('token')

if (Astro.request.method === "POST") {
  const data = await Astro.request.formData();
  const name = data.get("name");
  const password = data.get("password");

  // fetch to login credenials
  const response = await fetch(`${URL}/login`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    credentials: "include",
    body: JSON.stringify({ name, password }),
  })
    .then((res) => res.json())
    .then((res) => {
      console.log(res);
      if(res.token){
        Astro.cookies.set('token', res.token)
        Astro.response.headers.append('token', res.token)
      }
      
    })
    .catch((err) => console.error(err));
    
    if(Astro.cookies.has('token')){
      return Astro.redirect("/Home");
    } else {
      return Astro.redirect("/LoginError");
    }
}
---

<General>

  <!-- log in -->
  <div class="w-4/5 mx-auto mt-40 px-7 py-4 bg-[#3c3e46] rounded-lg shadow-xl ">
    <h2 class="mt-3 mb-9 text-2xl font-semibold">Log in</h2>
    <form method="POST" class="flex flex-col">
      <label class="mb-2 text-sm " for="name">Name</label>
      <input class="bg-[#343434] mb-8 py-2 pl-2  rounded-lg focus:outline-none focus:outline-2 focus:outline-purple-500 transition-all duration-75  "
       name="name" type="text" />
      <label class="mb-2 text-sm " for="password">Password</label>
      <input
        class="bg-[#343434] mb-3 rounded-lg py-2 pl-2  focus:outline-none focus:outline-2 focus:outline-purple-500 transition-all duration-75  "
        name="password"
        type="password"
      />
      <a class="self-end w-fit text-sm mb-4 text-[14px] font-semibold " href="/Register">Create account</a>
      <button class="  mt-3 mb-4 py-1.5 outline-none rounded-lg border-2 border-purple-500 bg-[#2b2d33] text-purple-500">Submit</button>
    </form>
  </div>
</General>
